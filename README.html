<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.2.3" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  background:#ffffff;
  margin:0;
  padding:20px 10px;
  font-size: small;
  font-family: sans-serif;
  color: #505050;
  margin: 1em 10% 1em 10%;
}

a {
  color: #005000;
}

a:visited {
  color: #005000;
}

a:hover {
  color: #002000;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: #000000;
}

h1, h2, h3, h4, h5, h6, div#toctitle {
  color: #227022;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
  font-weight: normal;
}

h1, h2, h3, div#toctitle {
  border-bottom: 1px solid;
  border-color: #000000;
}

h1 {
  font-size: x-large;
  }

h2, div#toctitle {
  padding-top: 0.5em;
  font-size: medium;
}
h3 {
  float: left;
  font-size: small;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: sans-serif;
  margin-left: 0;
}

hr {
  border: 1px solid;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #338033;
  font-family: sans-serif;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: x-small;
  border-top: 1px solid;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.5em;
  margin-left: 1em;
  margin-bottom: 1.5em;
/*  background: #eeffcc; */
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}

div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  color: #338033;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid;
}

div.exampleblock > div.content {
  border-left: 2px solid;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid ; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
div.olist2 ol {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}

div.addrblock > table {
  border: 0px 0px 0px 0px;
  border-style: none none none none;
  padding: 0px;
  margin: 10px;
  color: #000000;
}

table.addrblockbg {
  /*
  border-top: 1px solid;
  border-bottom: 1px solid;
  */
  background: #e0ffe0 ;
  border-style: none;
  outline-style: none;
}

thead {
  font-family: sans-serif;
  color: #000000;
}
tfoot {
  font-weight: bold;
  color: #000000;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hlist td {
  padding-bottom: 5px;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: .5ex;
  margin-bottom: 0;
  margin-left: 2em;
  line-height: 1.3;
}
div.toclevel1 {
  margin-top: 1ex;
}
div.toclevel2 {
  margin-left: 4em;
}

div.toclevel3 {
  margin-left: 6em;
}
div.toclevel4 {
  margin-left: 8em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){generateToc(2)}
/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, October 2006. License: GPL */

function getText(el) {
  var text = "";
  for (var i = el.firstChild; i != null; i = i.nextSibling) {
    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
      text += i.data;
    else if (i.firstChild != null)
      text += getText(i);
  }
  return text;
}

function TocEntry(el, text, toclevel) {
  this.element = el;
  this.text = text;
  this.toclevel = toclevel;
}

function tocEntries(el, toclevels) {
  var result = new Array;
  var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
  // Function that scans the DOM tree for header elements (the DOM2
  // nodeIterator API would be a better technique but not supported by all
  // browsers).
  var iterate = function (el) {
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
        var mo = re.exec(i.tagName)
        if (mo)
          result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
        iterate(i);
      }
    }
  }
  iterate(el);
  return result;
}

// This function does the work. toclevels = 1..4.
function generateToc(toclevels) {
  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementsByTagName("body")[0], toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "toc" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
}
/*]]>*/
</script>
<title>Python Bindings for Broccoli</title>
</head>
<body>
<div id="header">
<h1>Python Bindings for Broccoli</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<h2>Overview</h2><p/>
<div class="sectionbody">
<p>This Python module provides bindings for
<a href="http://www.icir.org/christian/broccoli/index.html">Broccoli</a>, Bro's
client communication library. In general, the bindings provide the
same functionality as Broccoli's C API.</p>
</div>
<h2>Download</h2><p/>
<div class="sectionbody">
<p>Since Bro 1.4, a stable version of the Python module ships as part
of the Bro distribution in <tt>aux/broccoli/bindings/python</tt>.</p>
<p>The most current development version is part of the Bro Subversion
repository. To get it, use:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; svn checkout http://svn.icir.org/bro/trunk/bro/aux/broccoli/bindings/python</tt></pre>
</div></div>
</div>
<h2>Installation</h2><p/>
<div class="sectionbody">
<p>Installation of the Python module is pretty straight-forward. After
Broccoli itself has been
<a href="http://www.icir.org/christian/broccoli/manual/c55.html">installed</a>,
it follows the standard installation process for Python modules:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; python setup.py install</tt></pre>
</div></div>
<p>Try the following to test the installation. If you do not see any
error message, everything should be fine:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; python -c "import broccoli"
&gt;</tt></pre>
</div></div>
</div>
<h2>Usage</h2><p/>
<div class="sectionbody">
<p>The following examples demonstrate how to send and receive Bro
events in Python.</p>
<p>The main challenge when using Broccoli from Python is dealing with
the data types of Bro event parameters as there is no one-to-one
mapping between Bro's types and Python's types. The Python modules
automatically maps between those types which both systems provide
(such as strings) and provides a set of wrapper classes for Bro
types which do not have a direct Python equivalent (such as IP
addresses).</p>
<h3>Connecting to Bro</h3><p/>
<p>The following code sets up a connection from Python to a remote Bro
instance (or another Broccoli) and provides a connection handle for
further communication:</p>
<div class="literalblock">
<div class="content">
<pre><tt>from broccoli import *
bc = Connection("127.0.0.1:47758")</tt></pre>
</div></div>
<p>An <tt>IOError</tt> will be raised if the connection cannot be established.</p>
<h3>Sending Events</h3><p/>
<p>Once you have a connection handle <tt>bc</tt> set up as shown above, you can
start sending events:</p>
<div class="literalblock">
<div class="content">
<pre><tt>bc.send("foo", 5, "attack!")</tt></pre>
</div></div>
<p>This sends an event called <tt>foo</tt> with two parameters, <tt>5</tt> and
<tt>attack!</tt>. Broccoli operates asynchronously, i.e., events scheduled
with <tt>send()</tt> are not always sent out immediately but might be
queued for later transmission. To ensure that all events get out
(and incoming events are processed, see below), you need to call
<tt>bc.processInput()</tt> regularly.</p>
<h3>Data Types</h3><p/>
<p>In the example above, the types of the event parameters are
automatically derived from the corresponding Python types: the first
parameter (<tt>5</tt>) has the Bro type <tt>int</tt> and the second one
(<tt>attack!</tt>) has Bro type <tt>string</tt>.</p>
<p>For types which do not have a Python equivalent, the <tt>broccoli</tt>
module provides wrapper classes which have the same names as the
corresponding Bro types. For example, to send an event called <tt>bar</tt>
with one <tt>addr</tt> argument and one <tt>count</tt> argument, you can write:</p>
<div class="literalblock">
<div class="content">
<pre><tt>bc.send("bar", addr("192.168.1.1"), count(42))</tt></pre>
</div></div>
<p>The following table summarizes the available atomic types and their
usage.</p>
<div class="tableblock">
<table rules="all"
frame="hsides"
cellspacing="0" cellpadding="4">
<caption class="title">Table: Bro vs. Python types</caption>
<col width="114" />
<col width="137" />
<col width="308" />
<thead>
  <tr>
    <th align="center">
    Bro Type
    </th>
    <th align="center">
    Python Type
    </th>
    <th align="center">
    Example
    </th>
  </tr>
</thead>
<tbody valign="top">
  <tr>
    <td align="center">
    addr
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>addr("192.168.1.1")</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    bool
    </td>
    <td align="center">
    bool
    </td>
    <td align="center">
    <tt>True</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    count
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>count(42)</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    double
    </td>
    <td align="center">
    float
    </td>
    <td align="center">
    <tt>3.14</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    enum
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <em>Type currently not supported</em>
    </td>
  </tr>
  <tr>
    <td align="center">
    int
    </td>
    <td align="center">
    int
    </td>
    <td align="center">
    <tt>5</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    interval
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>interval(60)</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    net
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <em>Type currently not supported</em>
    </td>
  </tr>
  <tr>
    <td align="center">
    port
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>port("80/tcp")</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    string
    </td>
    <td align="center">
    string
    </td>
    <td align="center">
    <tt>"attack!"</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    subnet
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>subnet("192.168.1.0/24")</tt>
    </td>
  </tr>
  <tr>
    <td align="center">
    time
    </td>
    <td align="center">
    
    </td>
    <td align="center">
    <tt>time(1111111111.0)</tt>
    </td>
  </tr>
</tbody>
</table>
</div>
<p>The <tt>broccoli</tt> module also supports sending Bro records as event
parameters. To send a record, you first define a record type. For
example, a Bro record type</p>
<div class="literalblock">
<div class="content">
<pre><tt>type my_record: record {
    a: int;
    b: addr;
    c: subnet;
};</tt></pre>
</div></div>
<p>turns into Python as</p>
<div class="literalblock">
<div class="content">
<pre><tt>my_record = record_type("a", "b", "c")</tt></pre>
</div></div>
<p>As the example shows, Python only needs to know the attribute names
but not their types. The types are derived automatically in the same
way as discussed above for atomic event parameters.</p>
<p>Now you can instantiate a record instance of the newly defined type
and send it out:</p>
<div class="literalblock">
<div class="content">
<pre><tt>rec = record(my_record)
rec.a = 5
rec.b = addr("192.168.1.1")
rec.c = subnet("192.168.1.0/24")
bc.send("my_event", rec)</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The Python module does not support nested records at this
time.</td>
</tr></table>
</div>
<h3>Receiving Events</h3><p/>
<p>To receive events, you define a callback function having the same
name as the event and mark it with the <tt>event</tt> decorator:</p>
<div class="literalblock">
<div class="content">
<pre><tt>@event
def foo(arg1, arg2):
    print arg1, arg2</tt></pre>
</div></div>
<p>Once you start calling <tt>bc.processInput()</tt> regularly (see above),
each received <tt>foo</tt> event will trigger the callback function.</p>
<p>By default, the event's arguments are always passed in with built-in
Python types. For Bro types which do not have a direct Python
equivalent (see table above), a substitute built-in type is used
which corresponds to the type the wrapper class' constructor expects
(see the examples in the table). For example, Bro type <tt>addr</tt> is
passed in as a string and Bro type <tt>time</tt> is passed in as a float.</p>
<p>Alternatively, you can define a <em>typed</em> prototype for the event. If you
do so, arguments will first be type-checked and then passed to the
call-back with the specified type (which means instances of the
wrapper classes for non-Python types). Example:</p>
<div class="literalblock">
<div class="content">
<pre><tt>@event(count, addr)
def bar(arg1, arg2):
    print arg1, arg2</tt></pre>
</div></div>
<p>Here, <tt>arg1</tt> will be an instance of the <tt>count</tt> wrapper class and
<tt>arg2</tt> will be an instance of the <tt>addr</tt> wrapper class.</p>
<p>Protoyping works similarly with built-in Python types:</p>
<div class="literalblock">
<div class="content">
<pre><tt>@event(int, string):
def foo(arg1, arg2):
    print arg1, arg2</tt></pre>
</div></div>
<p>In general, the prototype specifies the types in which the callback
wants to receive the arguments. This actually provides support for
simple type casts as some types support conversion to into something
different. If for instance the event source sends an event with a
single port argument, <tt>@event(port)</tt> will pass the port as an
instance of the <tt>port</tt> wrapper class; <tt>@event(string)</tt> will pass it
as a string (e.g., <tt>"80/tcp"</tt>); and <tt>@event(int)</tt> will pass it as an
integer without protocol information (e.g., just <tt>80</tt>). If an
argument cannot be converted into the specified type, a <tt>TypeError</tt>
will be raised.</p>
<p>To receive an event with a record parameter, the record type first
needs to be defined, as described above. Then the type can be used
with the <tt>@event</tt> decorator in the same way as atomic types:</p>
<div class="literalblock">
<div class="content">
<pre><tt>my_record = record_type("a", "b", "c")
@event(my_record)
def my_event(rec):
    print rec.a, rec.b, rec.c</tt></pre>
</div></div>
</div>
<h2>Helper Functions</h2><p/>
<div class="sectionbody">
<p>The <tt>broccoli</tt> module provides one helper function: <tt>current_time()</tt>
returns the current time as a float which, if necessary, can be
wrapped into a <tt>time</tt> parameter (i.e., <tt>time(current_time()</tt>)</p>
</div>
<h2>Examples</h2><p/>
<div class="sectionbody">
<p>There are some example scripts in
<a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/bindings/python/tests/"><tt>aux/broccoli/bindings/python/tests</tt></a>:</p>
<ul>
<li>
<p>
<a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/bindings/python/tests/broping.py"><tt>broping.py</tt></a>
   is a (simplified) Python version of Broccoli's test program
   <tt>broping</tt>. Start Bro with
   <a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/test/broping.bro"><tt>aux/broccoli/test/broping.bro</tt></a>.
</p>
</li>
<li>
<p>
Similarly,
   <a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/bindings/python/tests/broping-record.py"><tt>broping-record.py</tt></a>
   is a Python version of Broccoli's <tt>broping</tt> for records. Start
   Bro with
   <a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/test/broping-record.bro"><tt>aux/broccoli/test/broping-record.bro</tt></a>.
</p>
</li>
<li>
<p>
<a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/bindings/python/tests/test.py"><tt>test.py</tt></a>
   is a very ugly but comprehensive regression test and part of the
   communication test-suite. Start Bro with
   <a href="http://svn.icir.org/bro/branches/robin/work/aux/broccoli/bindings/python/tests/test.bro"><tt>test.bro</tt></a>.
</p>
</li>
</ul>
</div>
<div id="footer">
<div id="footer-text">
<a href="http://www.icir.org/robin">Back to Homepage</a><br />
</div>
</div>
</body>
</html>
